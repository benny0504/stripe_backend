<!DOCTYPE html>
<html>
<head>
  <title>Stripe Terminal Payment</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; }
    #status { color: blue; margin-top: 10px; }
  </style>
  <!-- Load scripts in correct order -->
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://js.stripe.com/terminal/v1/"></script>
</head>
<body>
  <h1>Take a Payment</h1>
  <input id="amount" type="number" placeholder="Enter amount in cents (e.g., 100, 500, 2000)">
  <button onclick="startPayment()">Pay Now</button>
  <p id="status">Status: Ready</p>

  <script>
    // Initialize first
    let stripe, terminal;

    // Initialize when both SDKs are loaded
    Promise.all([
      new Promise(resolve => {
        if(typeof Stripe === 'function') resolve();
        else window.addEventListener('stripe-loaded', resolve);
      }),
      new Promise(resolve => {
        if(typeof StripeTerminal === 'function') resolve();
        else window.addEventListener('terminal-loaded', resolve);
      })
    ]).then(() => {
      stripe = Stripe('pk_live_51QuKJvKfKNSn8CEg1mdEIobg8aFI2CKwc8kspxxVU7rcLvnkOINfHAbZtj0gnWF2au28AkKg8HeRXNxcDZgb1dDX00AhkwswGp');
      
      if(stripe.terminal) {
        terminal = stripe.terminal();
        console.log('Terminal initialized');
        document.getElementById('status').innerText = 'Status: Terminal ready';
      } else {
        console.error('Terminal not available');
        document.getElementById('status').innerText = 'Status: Terminal SDK failed';
      }
    });

    async function startPayment() {
      if(!terminal) {
        document.getElementById('status').innerText = 'Status: Terminal not ready - try again';
        return;
      }

      try {
        // Clear previous state
        document.getElementById('status').innerText = 'Status: Starting...';
        
        // Validate amount
        const amount = parseInt(document.getElementById('amount').value);
        if(!amount || amount < 100) throw new Error('Minimum amount: $1.00');

        // Get connection token
        const tokenRes = await fetch('https://stripe-backend-iu4y.onrender.com/connection_token');
        if(!tokenRes.ok) throw new Error('Connection failed');
        const { secret } = await tokenRes.json();
        terminal.setConnectionToken(secret);

        // Discover readers
        document.getElementById('status').innerText = 'Status: Searching readers...';
        const { discoveredReaders } = await terminal.discoverReaders();
        if(!discoveredReaders.length) throw new Error('No readers found');
        
        // Connect to first reader
        const reader = await terminal.connectReader(discoveredReaders[0]);
        document.getElementById('status').innerText = `Status: Connected to ${reader.label}`;

        // Create payment intent
        const intentRes = await fetch('https://stripe-backend-iu4y.onrender.com/create_payment_intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        });
        const { client_secret } = await intentRes.json();

        // Collect payment
        const { paymentIntent } = await terminal.collectPaymentMethod(client_secret);
        await terminal.processPayment(paymentIntent);
        document.getElementById('status').innerText = 'Status: Payment successful!';
        
      } catch(err) {
        document.getElementById('status').innerText = `Status: ${err.message}`;
        console.error('Payment error:', err);
      }
    }
  </script>
</body>
</html>
