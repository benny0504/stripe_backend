<!DOCTYPE html>
<html>
<head>
  <title>Stripe Terminal Payment</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; }
    #status { color: blue; margin-top: 10px; }
  </style>
  <script src="https://js.stripe.com/v3/" onload="console.log('Stripe.js loaded')"></script>
  <script src="https://js.stripe.com/terminal/v1/" onload="console.log('Terminal SDK loaded'); initTerminal()"></script>
</head>
<body>
  <h1>Take a Payment</h1>
  <input id="amount" type="number" placeholder="Enter amount in cents (e.g., 1000 = $10)" style="padding: 5px;">
  <button onclick="startPayment()">Pay Now</button>
  <p id="status">Status: Ready</p>

  <script>
    let stripe, terminal;
    function initTerminal() {
      stripe = Stripe('pk_test_xxxx'); // Your test publishable key
      if (typeof stripe.terminal === 'function') {
        terminal = stripe.terminal();
        console.log('Terminal initialized successfully');
        window.terminal = terminal;
      } else {
        console.error('Terminal SDK not available');
        document.getElementById('status').innerText = 'Status: Terminal SDK failed to load';
      }
    }

    async function startPayment() {
      if (!window.terminal) {
        document.getElementById('status').innerText = 'Status: Terminal not initialized';
        return;
      }
      try {
        const amount = document.getElementById('amount').value;
        if (!amount) {
          document.getElementById('status').innerText = 'Status: Please enter an amount';
          return;
        }
        document.getElementById('status').innerText = 'Status: Starting payment...';

        const tokenResponse = await fetch('https://stripe-backend-iu4y.onrender.com/connection_token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const tokenData = await tokenResponse.json();
        window.terminal.setConnectionToken(tokenData.secret);

        document.getElementById('status').innerText = 'Status: Finding reader...';
        const { discoveredReaders } = await window.terminal.discoverReaders({
          label: 'WSC513208022998'
        });
        if (discoveredReaders.length === 0) {
          document.getElementById('status').innerText = 'Status: No readers found';
          return;
        }
        const reader = discoveredReaders[0];

        document.getElementById('status').innerText = 'Status: Connecting to reader...';
        await window.terminal.connectReader(reader);

        document.getElementById('status').innerText = 'Status: Creating payment intent...';
        const intentResponse = await fetch('https://stripe-backend-iu4y.onrender.com/create_payment_intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: amount })
        });
        const intentData = await intentResponse.json();

        document.getElementById('status').innerText = 'Status: Tap, insert, or swipe card...';
        const { paymentIntent } = await window.terminal.collectPaymentMethod(intentData.clientSecret);

        document.getElementById('status').innerText = 'Status: Processing payment...';
        await window.terminal.processPayment(paymentIntent);

        document.getElementById('status').innerText = 'Status: Payment complete!';
      } catch (error) {
        document.getElementById('status').innerText = 'Status: Error - ' + error.message;
        console.error('Payment error:', error);
      }
    }
  </script>
</body>
</html>
